// @author Roman Torshin, Apache 2.0 licence
const o=e=>{let t={els:[],ie:{}},n=0,i=1,s=2,l=3,a="object",r="function",c,d=document,f=-1,g=0,h=0,p=[],u=0,y=0,m=e=>typeof e,S=(e,t)=>{for(let n in e)Object.hasOwnProperty.call(e,n)&&t(n,e)},L=o.onError||(()=>{}),C=e=>(...a)=>{try{let r=e(a[n],a[i],a[s],a[l]);return r!==c?r:t}catch(d){L(d)}},$=e=>{for(u=g;u<=f;u++)e()},E=e=>(m(e)!==a&&(e=o.first(e).el),e),Z=(e=!0,s=t.els)=>{let l=s.length;t.length=l,f=l-i,g=n,t.el=l?s[n]:c,t.last=l?s[f]:c,e&&(S(p,(e,n)=>{delete t[n[e]]}),p=[],t.ie={})},F=(e="")=>Array.from(d.querySelectorAll(e));t.reset=o;let v=(e,t,n)=>{S(t,i=>{let s=t[i];m(s)===r&&(s=s(n)),s!==c&&(["tag","sample","state"].includes(i)||(["html","innerHTML"].includes(i)?e.innerHTML=s:"dataset"===i&&m(s)===a?S(s,t=>{e.dataset[t]=s[t]}):"toggleClass"===i?e.classList.toggle(s):"addClass"===i?m(s)===a?e.classList.add(...s):e.classList.add(s):"removeClass"===i?e.classList.remove(s):"style"===i&&m(s)===a?S(s,t=>{e.style[t]=s[t]}):"append"===i&&m(s)===a?S(s.length?s:[s],t=>{e.appendChild(s[t])}):e.setAttribute(i,s)))}),e.dataset.oState=t.state};return t.init=C(e=>{let s=t.initID||o.inits.length||n;t.initID=s,Z(),o.inits[t.initID]=t,(m(e)!==a||e.render===c)&&(e={render:e}),S(e,l=>{p.push(l),t[l]=C((h=[{}])=>{let p=e[l]||{tag:"div"},S=t.els.slice(g,f+i);m(p)===a&&(p.state=l,p["data-o-init"]=s);let L=(e,t={})=>m(p)===a?d.createElement(p.tag||"div"):((u=d.createElement("div")).innerHTML=m(p)===r?p(t):p,u.children.length>i||!u.firstElementChild)?(u.dataset.oInit=e,u):(u.firstElementChild.dataset.oInit=e,u.firstElementChild);h.length||(h=[h]);let C=!S[n]&&"render"===l;h=h.map((e,n)=>(e.self=t,e.o=o,e.i=e.i===c?n:e.i,C&&S.push(L(s,e)),e)),C&&(t.els=S,Z(!1)),S&&(y=S.length===h.length,S.map((e,t)=>{h[y?t:n].i=t+g;let i=m(p)===r?p(h[y?t:n]):p;m(i)===a&&v(e,i,h[y?t:n])}))})})}),t.initState=C((e,n)=>{t.init(e).render(n)}),t.sample=C((e="render")=>{let i=t.els[g].attributes,s=t.els[g].dataset,l={tag:t.els[g].tagName,html:t.els[g].innerHTML,dataset:{}};for(let a of i)"data-"!==a.nodeName.substring(n,5)&&(l[a.nodeName]=a.value);return S(s,e=>{l.dataset[e]=s[e]}),{[e]:l}}),t.select=C(e=>{e===c&&(e=t.length-i),f=e,g=e,t.el=t.els[e],h=i}),t.all=C(()=>{f=t.length-i,g=n,t.el=t.els[n],h=n}),t.remove=C(e=>{e===c&&h&&(e=g),e!==c?t.els[e].parentNode.removeChild(t.els[e]):$(()=>{t.els[u].parentNode.removeChild(t.els[u])}),Z(!1)}),t.skip=C(e=>{e===c&&(e=g),t.els.splice(u,i),Z()}),t.add=C((e,i)=>{"string"===m(e)&&""!==e?t.els.push(...F(e)):m(e)===a?e.tagName?t.els.push(e):e.els?t.els.push(...e.els):e.length&&e[n].tagName&&t.els.push(...e):"number"===m(e)&&o.inits[e]&&(t=o.inits[e]),Z(!1),t.initID!==c&&t.dataset({oInit:t.initID})}),t.appendInside=C(e=>{$(()=>{E(e).appendChild(t.els[u])})}),t.appendBefore=C(e=>{$(()=>{E(e).parentNode.insertBefore(t.els[u],E(e))})}),t.appendAfter=C(e=>{$(()=>{E(e).after(...t.els)})}),t.find=C((e="")=>{let n=[];$(()=>{n.push(...Array.from(t.els[u].querySelectorAll(":scope "+e)))}),t.els=n,Z()}),t.first=C((e="")=>{let n=c,i=[];$(()=>{(n=t.els[u].querySelector(e))&&i.push(n)}),t.els=i,Z()}),t.attr=C((e,i)=>{if(e){if(i===c){let s=[];return $(()=>{s[u]=t.els[u].getAttribute(e)}),h?s[n]:s}""!==i?$(()=>{t.els[u].setAttribute(e,i)}):$(()=>{t.els[u].removeAttribute(e)})}}),t.attrs=C(()=>{let e=[];return $(()=>{let n={};[...t.els[u].attributes].forEach(e=>{n[e.nodeName]=e.nodeValue}),e.push(n)}),h?e[n]:e}),t.dataset=C(e=>{if(typeof e===a)$(()=>{S(e,n=>{t.els[u].dataset[n]=e[n]})});else{let i=[];return $(()=>{i.push({...t.els[u].dataset})}),h?i[n]:i}}),t.style=C(e=>{t.attr("style",e)}),t.css=C((e={})=>{let n="";S(e,t=>{n+=t+":"+e[t].replace('"',"'")+";"}),t.style(n)}),t.setClass=C(e=>{$(()=>{t.els[u].setAttribute("class",e)})}),t.addClass=C(e=>{$(()=>{t.els[u].classList.add(e)})}),t.removeClass=C(e=>{$(()=>{t.els[u].classList.remove(e)})}),t.toggleClass=C((e,n)=>{$(()=>{t.els[u].classList.toggle(e,n)})}),t.haveClass=e=>{let n=!0;return $(()=>{t.els[u].classList.contains(e)||(n=!1)}),n},t.innerHTML=C(e=>{if(e!==c)$(()=>{t.els[u].innerHTML=e});else{let n="";return $(()=>{n+=t.els[u].innerHTML}),n}}),t.innerText=C((e="")=>{$(()=>{t.els[u].innerText=e})}),t.textContent=C((e="")=>{$(()=>{t.els[u].textContent=e})}),t.html=C(e=>{if(e)t.innerHTML(e);else{let n="";return $(()=>{n+=t.els[u].outerHTML}),n}}),t.forEach=C(e=>{t.initState(e)}),t.on=C((e,n,i,s)=>{e.split(", ").forEach(e=>{$(()=>{t.els[u].addEventListener(e,n,i,s)}),t.ie[e]||(t.ie[e]=[]),t.ie[e].push([n,i,s])})}),t.off=C((e,i,s)=>{e.split(", ").forEach(e=>{$(()=>{t.els[u].removeEventListener(e,i,s)}),t.ie[e]&&(t.ie[e]=t.ie[e].filter(e=>e[n]!==i))})}),t.onAll=C((e,l)=>{S(t.ie,(a,r)=>{e&&e!==a||r[a].forEach(e=>{$(()=>{l?t.els[u].removeEventListener(a,e[n]):t.els[u].addEventListener(a,e[n],e[i],e[s])})})})}),t.offAll=C(e=>{t.onAll(e,i)}),e&&t.add(e),t.take=e=>{if(t.add(e),t.el){let s=t.el.dataset.oInit;if(s!==c&&o.inits[s])return t.length===i?(y=t.els[n],Object.assign(t,o.inits[s]),t.els=[y]):t=o.inits[s],Z(!1,t.els),t}},t};o.first=e=>o(document.querySelector(e)||""),o.inits=[],o.onError=!1,o.init=e=>o().init(e),o.initState=(e,t)=>o().init(e).render(t),o.take=e=>o().take(e),o.Z=0,o.N=1,o.W=2,o.H=100,o.F=!1,o.C=(e,t)=>Object.hasOwnProperty.call(e,t),o.ajax=(e,t={})=>{let n=new URLSearchParams;if(t.data&&"object"==typeof t.data){for(let i in t.data)o.C(t.data,i)&&("object"==typeof t.data[i]?n.set(i,encodeURIComponent(JSON.stringify(t.data[i]))):n.set(i,t.data[i]));"GET"===t.method||"get"===t.method?e+="?"+n.toString():t.body||(t.body=n),delete t.data}return fetch(e,t)},o.get=(e,t={})=>o.ajax(e,{...t,method:"GET"}),o.post=(e,t={})=>o.ajax(e,{...t,method:"POST"}),o.getParams=e=>{let t={},n=new URLSearchParams(window.location.search).entries();for(let i of n)t[i[o.Z]]=i[o.N];return e?t[e]:t},o.incCache=!0,o.incCacheExp=864e5,o.incTimeout=6e3,o.incSource="",o.incForce=o.F,o.incAsync=!0,o.incCors=o.F,o.incFns={},o.incSet=[o.Z],o.incReady=[o.Z],o.incN=o.Z,o.incCheck=(e=0,t,n=0)=>!n&&e&&t===o.U&&o.incReady[e]?o.incSet[e]===o.N:o.incReady[e]===o.U||o.incReady[e][t]===o.U?o.F:(o.incReady[e][t].loaded=n,o.incFns[o.incReady[e][t].name]=n,o.incReady[e][o.Z]+=n,e&&o.incReady[e].length===o.incReady[e][o.Z]&&("function"==typeof o.incSet[e]&&o.incSet[e](e),o.incSet[e]=o.N),o.incSet[e]===o.N),o.incCacheClear=(e=o.F)=>{for(let t in o.incFns)o.C(o.incFns,t)&&(localStorage.removeItem("inc-"+t),localStorage.removeItem("inc-"+t+"Expires"));return e&&(o.incReady.forEach((e,t)=>{t&&e.forEach((e,n)=>{n&&o("#oInc-"+t+"-"+n).remove()})}),o.incN=o.Z,o.incFns={},o.incSet=[o.Z],o.incReady=[o.Z]),!0},o.inc=(e,t,n)=>{let i=o.Z,s=o.Z,l="function";if("object"!=typeof e||!e)return o.incSet[o.Z];o.incSet[o.Z]++;let a=o.incSet[o.Z];o.incSet[a]=t||o.Z,o.incReady[a]=[];let r=o.incReady[a];r[o.Z]=o.N;let c={};for(let d in e)if(o.C(e,d)){i++,o.incN++;let f=e[d].indexOf(".css")>-1?"style":"script";if(e[d]=(o.incSource?o.incSource+"/":"")+e[d],isNaN(d)&&o.C(o.incFns,d)&&o.incFns[d]&&!o.incForce){r[i]={name:d,loaded:o.N},s++;continue}if(r[i]={name:d,loaded:o.Z},isNaN(d)&&(o.incFns[d]=o.Z),isNaN(d)&&o.incCache&&"http"!==e[d].substring(o.Z,4)&&"file:"!==window.location.protocol&&(e[d].indexOf(".css")>-1||e[d].indexOf(".js")>-1)){let g=localStorage,h=g.getItem("inc-"+d),p=g.getItem("inc-"+d+"Expires");h&&p&&new Date().getTime()<p?(o.initState({tag:f,id:"oInc-"+a+"-"+i,innerHTML:h,"data-o-inc":a}).appendInside("head"),r[i].loaded=o.N,o.incFns[d]=o.N,s++):(c[d]=i,o.get(e[d],{mode:o.incCors?"cors":"same-origin"}).then(t=>{if(200!==t.status){o.onError&&o.onError({message:o.incSource+e[d]+" was not loaded"});return}t.text().then(e=>{g.setItem("inc-"+d,e),g.setItem("inc-"+d+"Expires",new Date().getTime()+o.incCacheExp),o.initState({tag:f,id:"oInc-"+a+"-"+c[d],innerHTML:e,"data-o-inc":a}).appendInside("head"),o.incCheck(a,c[d],o.N)})}))}else{let u={tag:f,id:"oInc-"+a+"-"+i,"data-o-inc":a,async:o.incAsync,onload:"o.incCheck("+a+","+i+",1)"};e[d].indexOf(".css")>-1?(u.tag="link",u.rel="stylesheet",u.href=e[d]):(e[d].indexOf(".js")>-1||(u.tag="img",u.style="display:none;"),u.src=e[d]),o.initState(u).appendInside(u.style?"body":"head")}}return r[o.Z]+=s,i!==o.Z&&(s===i?typeof t===l&&t(a):setTimeout(e=>{o.incReady[e]&&o.incReady[e].length<o.incReady[e][o.Z]&&(o.incSet[e]=o.Z,typeof n===l&&n(a))},o.incTimeout,a)),o.incSet[o.Z]},o.tLog=[],o.tRes=[],o.tStatus=[],o.tFns=[],o.tShowOk=o.F,o.tStyled=o.F,o.tTime=2e3,o.tPre='<div style="font-family:monospace;text-align:left;">',o.tOk='<span style="background:#cfc;padding: 0 15px;">OK</span> ',o.tXx='<div style="background:#fcc;padding:3px;">',o.tDc="</div>",o.test=(e="",...t)=>{let n=o.tLog.length,i=0,s="├ OK: ",l="├ ✘ ",a="\n",r="\n",c=t.length,d=o.Z;"function"==typeof t[c-o.N]&&(o.tFns[n]=t[c-o.N],c--),o.tStyled?(o.tLog[n]="<div><b>"+e+" #"+n+"</b></div>",s=o.tPre+o.tOk,l=o.tPre+o.tXx,r=(a=o.tDc)+a):o.tLog[n]=e+" #"+n+"\n",o.tRes[n]=o.F,o.tStatus[n]=[];for(let f=o.Z;f<c;f++){let g={n:n,i:f,title:t[f][o.Z],tShowOk:o.tShowOk,tStyled:o.tStyled},h=t[f][o.N];if("function"==typeof h)try{h=h(g)}catch(p){h=p.message,o.onError&&o.onError(p)}o.tStatus[n][f]="string"==typeof h?o.F:h,!0===h?(d++,o.tShowOk&&(o.tLog[n]+=s+t[f][o.Z]+a)):h!==o.U?o.tLog[n]+=l+t[f][o.Z]+(h!==o.F?": <i>"+h+"</i>":"")+r:(i++,setTimeout(e=>{e.title+=" (timeout)",o.testUpdate(e)},o.tTime,g))}return o.tRes[n]=d===c,o.tStyled?o.tLog[n]+=o.tPre+'<div style="color:'+(d+i!==c?"red":"green")+';"><b>':o.tLog[n]+=i?"├":"└ ",o.tLog[n]+="DONE "+d+"/"+(c-i),i&&(o.tLog[n]+=", waiting: "+i),o.tStyled?o.tLog[n]+="</b>"+o.tDc+o.tDc:o.tLog[n]+="\n",i||"function"!=typeof o.tFns[n]||o.tFns[n](n),n},o.testUpdate=(e,t=o.F,n="")=>{if(o.tStatus[e.n][e.i]===o.U){o.tStatus[e.n][e.i]=!0===t,!0===t?e.tShowOk&&(e.tStyled?o.tLog[e.n]+=o.tPre+o.tOk+e.title+n+o.tDc:o.tLog[e.n]+="└ OK: "+e.title+n+"\n"):(o.tRes[e.n]=o.F,e.tStyled?o.tLog[e.n]+=o.tPre+o.tXx+e.title+n+(t?": "+t:"")+o.tDc+o.tDc:o.tLog[e.n]+="└ ✘ "+e.title+(t?": "+t:"")+n+"\n");let i=o.Z,s=i;for(let l of o.tStatus[e.n]){if(l===o.U)return;!l&&i++,s++}o.tRes[e.n]=!i;let a=i?"FAILED "+i+"/"+s:"DONE "+s+"/"+s;e.tStyled?o.tLog[e.n]+=o.tPre+'<b style="color:'+(i?"red":"green")+';">'+a+"</b>"+o.tDc:o.tLog[e.n]+="└ "+a,"function"==typeof o.tFns[e.n]&&o.tFns[e.n](e.n)}};
